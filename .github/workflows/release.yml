name: Release Desktop Apps

on:
  push:
    tags:
      - 'v*' # Trigger on version tags like v0.1.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  create-release:
    runs-on: ubuntu-latest
    outputs:
      release_id: ${{ steps.create-release.outputs.result }}
      release_upload_url: ${{ steps.create-release.outputs.upload_url }}

    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get version from tag
        id: get_version
        run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT

      - name: Create Release
        id: create-release
        uses: actions/github-script@v7
        with:
          script: |
            const { data } = await github.rest.repos.createRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              tag_name: context.ref.replace('refs/tags/', ''),
              name: `OpenScans ${context.ref.replace('refs/tags/', '')}`,
              body: 'Release notes will be updated after builds complete.',
              draft: true,
              prerelease: false
            })
            return data.id

  build-tauri:
    needs: create-release
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: 'macos-latest' # macOS (Intel)
            args: '--target x86_64-apple-darwin'
          - platform: 'macos-latest' # macOS (Apple Silicon)
            args: '--target aarch64-apple-darwin'
          - platform: 'ubuntu-22.04' # Linux
            args: ''
          - platform: 'windows-latest' # Windows
            args: ''

    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v3
        with:
          version: 10

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install Rust stable
        uses: dtolnay/rust-toolchain@stable
        with:
          # macOS universal build requires both targets
          targets: ${{ matrix.platform == 'macos-latest' && 'aarch64-apple-darwin,x86_64-apple-darwin' || '' }}

      - name: Install dependencies (Ubuntu only)
        if: matrix.platform == 'ubuntu-22.04'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libwebkit2gtk-4.1-dev libappindicator3-dev librsvg2-dev patchelf libsoup-3.0-dev

      - name: Install frontend dependencies
        run: pnpm install --frozen-lockfile

      - name: Update version from tag
        shell: bash
        run: |
          # Extract version from tag (remove 'v' prefix)
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "Building version $VERSION from tag $GITHUB_REF"

          # Update package.json
          sed "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" package.json > package.json.tmp && mv package.json.tmp package.json

          # Update tauri.conf.json
          sed "s/\"version\": \"[^\"]*\"/\"version\": \"$VERSION\"/" src-tauri/tauri.conf.json > src-tauri/tauri.conf.json.tmp && mv src-tauri/tauri.conf.json.tmp src-tauri/tauri.conf.json

          # Update Cargo.toml
          sed "s/^version = \"[^\"]*\"/version = \"$VERSION\"/" src-tauri/Cargo.toml > src-tauri/Cargo.toml.tmp && mv src-tauri/Cargo.toml.tmp src-tauri/Cargo.toml

          echo "Updated all config files to version $VERSION"
          cat package.json | grep version
          cat src-tauri/tauri.conf.json | grep version
          cat src-tauri/Cargo.toml | grep version

      # Build Tauri app (unsigned for now - signing can be added later by configuring secrets)
      - name: Build Tauri app
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Note: macOS code signing requires APPLE_CERTIFICATE, APPLE_CERTIFICATE_PASSWORD,
          # APPLE_SIGNING_IDENTITY, APPLE_ID, APPLE_PASSWORD secrets to be configured.
          # Without these, builds will be unsigned (users need to right-click -> Open on first launch)
        with:
          releaseId: ${{ needs.create-release.outputs.release_id }}
          tagName: ${{ github.ref_name }}
          releaseName: "OpenScans v__VERSION__"
          releaseBody: "See https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }} for release notes"
          args: ${{ matrix.args }}

  publish-release:
    needs: [create-release, build-tauri]
    runs-on: ubuntu-latest

    steps:
      - name: Publish Release
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.repos.updateRelease({
              owner: context.repo.owner,
              repo: context.repo.repo,
              release_id: ${{ needs.create-release.outputs.release_id }},
              draft: false
            })
